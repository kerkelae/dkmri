import numpy as np
import numpy.testing as npt

import dkmri


SEED = 123

params = np.array(
    [
        7.90764792,
        0.88660664,
        0.82186469,
        0.81741033,
        0.25016042,
        0.12341918,
        0.28344717,
        0.97744794,
        0.64809536,
        0.54047796,
        0.09333558,
        -0.06614247,
        0.07547532,
        0.16822022,
        0.12438352,
        0.14840455,
        0.16173709,
        0.17534938,
        0.42078548,
        -0.05851049,
        0.07203667,
        0.12034342,
    ]
)


def test__design_matrix():
    bvals = np.arange(5)
    bvecs = np.array(
        [
            [1.0, 0.0, 0.0],
            [1.0, 0.0, 0.0],
            [1.0, 0.0, 0.0],
            [0.0, 1.0, 0.0],
            [0.0, 0.0, 1.0],
        ]
    )
    desired_X = np.array(
        [
            [1.0, 1.0, 1.0, 1.0, 1.0],
            [0.0, -1.0, -2.0, -0.0, -0.0],
            [0.0, -0.0, -0.0, -3.0, -0.0],
            [0.0, -0.0, -0.0, -0.0, -4.0],
            [0.0, -0.0, -0.0, -0.0, -0.0],
            [0.0, -0.0, -0.0, -0.0, -0.0],
            [0.0, -0.0, -0.0, -0.0, -0.0],
            [0.0, 1 / 6, 2 / 3, 0.0, 0.0],
            [0.0, 0.0, 0.0, 1.5, 0.0],
            [0.0, 0.0, 0.0, 0.0, 8 / 3],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0],
        ]
    ).T
    X = dkmri._design_matrix(bvals, bvecs)
    npt.assert_almost_equal(X, desired_X)


def test__params_to_D():
    desired_D = np.array(
        [
            [0.88660664, 0.25016042, 0.12341918],
            [0.25016042, 0.82186469, 0.28344717],
            [0.12341918, 0.28344717, 0.81741033],
        ]
    )
    D = dkmri._params_to_D(params)
    npt.assert_almost_equal(D, desired_D)


def test__params_to_W():
    desired_W = np.array(
        [
            [
                [
                    [1.37882815, 0.131663, -0.09330328],
                    [0.131663, 0.22815298, -0.0825373],
                    [-0.09330328, -0.0825373, 0.24735503],
                ],
                [
                    [0.131663, 0.22815298, -0.0825373],
                    [0.22815298, 0.10646858, 0.10161789],
                    [-0.0825373, 0.10161789, 0.16976136],
                ],
                [
                    [-0.09330328, -0.0825373, 0.24735503],
                    [-0.0825373, 0.10161789, 0.16976136],
                    [0.24735503, 0.16976136, 0.17546049],
                ],
            ],
            [
                [
                    [0.131663, 0.22815298, -0.0825373],
                    [0.22815298, 0.10646858, 0.10161789],
                    [-0.0825373, 0.10161789, 0.16976136],
                ],
                [
                    [0.22815298, 0.10646858, 0.10161789],
                    [0.10646858, 0.9142299, 0.23729835],
                    [0.10161789, 0.23729835, 0.59357726],
                ],
                [
                    [-0.0825373, 0.10161789, 0.16976136],
                    [0.10161789, 0.23729835, 0.59357726],
                    [0.16976136, 0.59357726, 0.20934554],
                ],
            ],
            [
                [
                    [-0.09330328, -0.0825373, 0.24735503],
                    [-0.0825373, 0.10161789, 0.16976136],
                    [0.24735503, 0.16976136, 0.17546049],
                ],
                [
                    [-0.0825373, 0.10161789, 0.16976136],
                    [0.10161789, 0.23729835, 0.59357726],
                    [0.16976136, 0.59357726, 0.20934554],
                ],
                [
                    [0.24735503, 0.16976136, 0.17546049],
                    [0.16976136, 0.59357726, 0.20934554],
                    [0.17546049, 0.20934554, 0.76242038],
                ],
            ],
        ]
    )
    W = dkmri._params_to_W(params)
    npt.assert_almost_equal(W, desired_W)
